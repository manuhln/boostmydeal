# Pie-Speech - #1 Arabic AI Calling Platform
### منصة الاتصال الذكي الرائدة للعملاء العرب

## Overview
Pie-Speech is the premier Arabic AI calling platform designed specifically for Arabic-speaking businesses and customers. This comprehensive solution enables creating, managing, and monitoring AI voice agents optimized for Arabic communication. The platform is capable of conducting phone calls, tracking metrics, and managing customer interactions in Arabic markets. It aims to streamline business communication and customer engagement through advanced AI voice technology tailored for Arabic speakers, offering capabilities like multi-tenant support, real-time analytics, and customizable workflow automation. The business vision is to provide a versatile platform that enhances customer engagement and operational efficiency for Arabic businesses through intelligent voice AI.

## User Preferences
Preferred communication style: Simple, everyday language.

## Recent Changes (October 31, 2025)
- **Callback Request Management and Automated Scheduling**: Implemented complete automated callback system with two components: (1) Callback tracking through TRANSCRIPT_COMPLETE webhook - when callback_requested is true, the system creates a record in the Callbacks collection, copying all call data with callback_time field for scheduling. The Callbacks model mirrors the Call schema with callbacks_time field. (2) Automated callback execution via CallbackScheduler service using node-cron pattern - runs every minute checking for callbacks matching current UTC time (date/hour/minute, ignoring seconds), initiates outbound calls using demoCreateCallWithAgent() with callback data, and deletes callback records only after confirmed success (result.callId exists). Features individual error isolation, field validation, structured logging, and automatic retry for failed callbacks. This enables systematic follow-up on customer callback requests with full context from the original call.
- **Previous Call History Context**: Implemented comprehensive call history memory system for outbound calls. When initiating outbound calls, the system now automatically retrieves and includes a summary of the latest 3 completed calls with the same contact in the JSON payload sent to the telephonic server. The previous_call_summary parameter provides the AI agent with context from past interactions, including call dates, durations, and summaries extracted from CALL_SUMMARY webhooks (with fallback to transcript snippets of up to 500 characters per call). The current_date and current_time are also included in the payload to give agents awareness of the current timestamp. This enables agents to have memory of previous conversations and provide more contextual, personalized interactions.
- **Welcome Email System**: Implemented automated welcome emails for new user signups. When users create accounts, they receive professional HTML emails detailing platform features including AI voice agents, workflow automation, call management, analytics, CRM integrations, and team collaboration. Email follows the same branded template format as forgot password and team invitation emails with Pie-Speech styling and comprehensive feature overview to help new users get started.
- **Monthly Invoice Email System**: Implemented comprehensive automated monthly invoice system within the billing module architecture. Features include InvoiceEmailService for generating detailed invoice data and professional HTML email templates, InvoiceScheduler with cron job automation to send invoices on the 1st of each month for previous month's billing, and manual invoice trigger endpoints for admin users. Invoice emails include payment history, billing summaries, account balance information, and follow Pie-Speech branding standards. System only sends invoices for organizations with payment activity or credit usage.
- **Integrated Invoice Management Interface**: Successfully integrated invoice management functionality into Settings page billing tab instead of separate billing page. Added real-time scheduler status display, manual invoice sending controls with proper month/year parameters, and informational sections explaining the automated monthly invoice system. Removed separate billing page and consolidated all billing functionality within Settings.
- **Call Connection Timeout System**: Implemented automated timeout detection for calls that don't receive PHONE_CALL_CONNECTED webhooks within 2 minutes after initiation. System automatically marks such calls as 'failed' with a CALL_TIMEOUT webhook entry, preventing calls from remaining stuck in 'in-progress' status indefinitely. Features dedicated CallTimeoutWorker with BullMQ job scheduling and Redis-based queue management.
- **Enhanced Call Success/Failure Handling**: Modified outbound call system to determine success/failure based on call_id presence in telephonic server response. Calls now return proper success/failure status with call_id only when received from external server, eliminating false positive "call successfully initiated" messages.
- **Secure API URL Configuration**: Moved telephonic server URL from hardcoded value to environment variable (TELEPHONIC_SERVER_URL) for better security and configuration management.
- **Enhanced Voicemail Detection**: Fixed webhook handling to properly detect voicemail in both PHONE_CALL_ENDED and TRANSCRIPT_COMPLETE events. Calls with voicemail detection now correctly show "voicemail" status instead of "completed". Fixed existing call with Twilio SID `hOoqiRrad_T7droM2izLiA` from showing "completed" to proper "voicemail" status.
- **Real-time Call Log Updates**: Implemented automatic call log refresh every 3 seconds for real-time status updates without page reload.
- **Comprehensive Voicemail Detection**: System now detects voicemail from multiple webhook event types (VOICEMAIL_DETECTED, PHONE_CALL_ENDED, TRANSCRIPT_COMPLETE) with various field names (is_voicemail, voicemail_detected) ensuring accurate status updates.
- **Enhanced Button Loading States**: Added visual loading spinners and improved disabled states for call initiation and agent creation/update buttons. Buttons now show animated spinners during operations with proper opacity reduction and cursor changes to prevent double-clicking and provide clear visual feedback.
- **ElevenLabs Manual Voice Management**: Completely transitioned ElevenLabs voice services from API-fetched voices to manually provided voices. Implemented 11 curated voices (Mark, Niraj, David, Monika, Muskan, Simran, Viraj, Alxendra, Anna) with embedded personality data including gender, age, accent, tone, and language characteristics. System now shows only manually provided voices and cloned voices, eliminating external API dependencies for voice selection.
- **Language-Based Voice Filtering**: Implemented sophisticated language filtering for agent creation where voices are filtered based on their characteristics. Supports English, Hindi, Spanish, and French language filtering, showing voices that contain the selected language or "International" designation in their characteristics array. This ensures users only see appropriate voices for their chosen agent language during the creation process.
- **Duplicate Call Prevention System**: Implemented comprehensive duplicate call prevention to resolve issues where single call requests created multiple call records. Added 60-second duplicate detection window for active calls, enhanced error handling with specific messaging for duplicate attempts, database index optimization for faster duplicate detection, and frontend loading states to prevent rapid button clicking. System now checks for existing calls to the same number with the same agent within the last minute before creating new call records.

## System Architecture
The platform is built with a full-stack architecture. The **Frontend** uses React with TypeScript, Wouter for routing, TanStack Query for state management, shadcn/ui for components, Tailwind CSS for styling, and Vite for building. Form handling is managed with React Hook Form and Zod validation. The **Backend** is built with Node.js and Express.js in TypeScript, using MongoDB for data persistence with Mongoose ODM. It implements JWT-based authentication with bcrypt hashing and supports multi-tenancy. For data access, an enterprise-grade Data Access Layer (DAL) provides descriptive, business-focused methods, abstracting database operations and ensuring separation of concerns.

**Key Architectural Decisions and Features:**
- **Multi-Tenant Database Schema**: MongoDB collections are isolated per organization (Organizations, Users, Agents, Calls, Metrics, Contacts).
- **Voice Provider Integration**: A factory pattern allows integration with multiple voice AI providers for call initiation, status tracking, and transcript retrieval.
- **Authentication & Authorization**: Secure JWT authentication, protected routes, role-based access control (owner, admin, manager, agent), and organization-level data isolation.
- **Workflow Management**: A visual workflow builder allows users to design automated processes with nodes for triggers, AI agents, conditions, and actions (e.g., email, CRM interactions, outbound calls). Workflows are executed asynchronously based on webhook events.
- **RAG (Retrieval-Augmented Generation)**: Supports uploading multiple PDF documents to create a knowledge base for AI agents, enabling them to access document-specific information during calls. RAG generation uses a complete replacement logic, where old RAG data is replaced with new data on every update/create.
- **Call Metrics**: Comprehensive metrics system to track call performance, including total calls, call duration, and tag-based categorization. Features date-based filtering with manual trigger via Filter button for enhanced user control.
- **CRM Integrations**: Supports integration with HubSpot and Zoho CRM for managing contacts, deals, and companies. Workflow nodes enable actions like creating, updating, and searching for deals by name within these CRMs. Features "Get Deal" functionality in the integrations interface for both HubSpot and Zoho, allowing users to search and retrieve deal information by name with formatted results displaying deal details, amounts, stages, and owner information.
- **Team Management**: Comprehensive backend and frontend system for managing teams, including inviting members, assigning roles, and tracking pending invites with enhanced email notifications and token-based acceptance. Features 24-hour invitation expiration (updated from 7 days), professional HTML email templates with Pie-Speech branding, footer content, and legal disclaimers. Supports re-inviting previously deleted users by reactivating their accounts.
- **Email Communication System**: Complete email notification system supporting multiple types: welcome emails for new signups, forgot password emails with secure reset links, and team invitation emails. All emails follow consistent Pie-Speech branding with professional HTML templates, feature overviews, Arabic language support, and clear call-to-action buttons. System gracefully handles SMTP failures without breaking user flows.
- **Forgot Password Functionality**: Complete password reset system for users who cannot log in, including forgot password form on login page, secure token-based email links with 1-hour expiration, and professional email templates. This is separate from the profile page password change feature (which requires current password knowledge). Uses same URL pattern as team invites for consistent domain handling.
- **Credit-Based Billing System**: Complete implementation of organization-level credit management with $5 initial free credits, automatic credit deduction on call completion, credit checking before call initiation (blocks calls with insufficient funds), low balance warnings at $1 threshold, and Stripe payment integration for credit top-ups. Integrated into Settings > Billing tab with comprehensive billing dashboard.
- **Voicemail Detection**: Agents can be configured with voicemail detection and custom voicemail messages.
- **UI/UX**: Features a consistent black/white/#3B82F6 blue color scheme, providing a modern and unified visual experience across the platform, including redesigned login/signup, dashboard, and assistant creation pages. Reusable components like delete confirmation modals and dynamic voice selection enhance user interaction. The platform emphasizes Arabic-first design with bilingual support (English/Arabic) throughout key user-facing elements.

## External Dependencies
- **Voice AI Providers**: Vapi, ElevenLabs, Deepgram, Rime, Stream Elements (requires respective API keys).
- **Database**: MongoDB (requires `MONGODB_URI` or `DATABASE_URL`).
- **Job Queue**: BullMQ with Redis Cloud for asynchronous job processing (e.g., outbound calls, webhook handling).
- **Authentication**: JSON Web Tokens (JWT) for secure authentication (requires `JWT_SECRET`).
- **Email Integration**: Nodemailer for SMTP email sending, integrated via a factory pattern for various email service providers.
- **CRM Integrations**: HubSpot, Zoho CRM (requires respective API keys/OAuth credentials).
- **Development & Deployment**: Replit, Vite, TypeScript, esbuild.